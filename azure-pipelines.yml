trigger:
- master
- warrior

jobs:
- job: testJob
  timeoutInMinutes: 0

  pool:
    vmImage: 'ubuntu-latest'

  variables:
    DISTRO: 'poky-freertos'
    SSTATE_MIRRORS: 'file://.* http://sstate.yoctoproject.org/2.99/PATH;downloadfilename=PATH;downloadfilename=PATH'
    MACHINE: 'qemuarmv5'


  steps:
  - script: echo Testing a Meta-FreeRTOS build!
    displayName: 'echoInit'

  - bash: |                                                                                                                   
      # Install dependencies
      echo "Installing dependencies"
      sudo apt-get install gawk wget git-core diffstat unzip texinfo gcc-multilib \
      build-essential chrpath socat cpio python python3 python3-pip python3-pexpect \
      xz-utils debianutils iputils-ping libsdl1.2-dev xterm
      cd
      # Clone repositories
      echo "Cloning YP"                                                                                                                 
      git clone git://git.yoctoproject.org/poky                                                                             
      cd poky
      echo "Cloning meta-freertos"                                                                                                                 
      git clone https://github.com/aehs29/meta-freertos.git                                                                                                      
      source oe-init-build-env                                                                                              
      echo "MACHINE = \"${MACHINE}\"" >> ./conf/local.conf                                                                  
      echo "DISTRO = \"${DISTRO}\"" >> ./conf/local.conf                                                                    
      echo "SSTATE_MIRRORS = \"${SSTATE_MIRRORS}\"" >> ./conf/local.conf                                                    
        bitbake-layers add-layer ../meta-freertos
      # Build
      echo "Building sample applications"                                                                          
      bitbake freertos-demo-local -k
      bitbake freertos-demo -k
    displayName: 'Test FreeRTOS applications'